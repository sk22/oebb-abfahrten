<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<title>Webdisplay scroller</title>
		<style>
			html {
				color-scheme: dark;
				overflow: hidden;
			}

			body {
				margin: 0;
				line-height: 0;
				transform-origin: top;
				display: flex;
				scale: var(--scale);
			}

			section {
				flex: 1;
				container-type: inline-size;
				overflow: auto;
				scrollbar-width: none;
				height: calc(100svh * pow(var(--scale), -1));
			}

			iframe {
				border: none;
				width: 100%;
				aspect-ratio: 16 / 9;
				pointer-events: none;
			}

			a[data-content-type="construction"] > iframe {
				aspect-ratio: 16 / 7;
			}

			a {
				display: block;
				position: relative;

				--headline-height-vh: 9.3cqw; /* vh height of .headline */
				--header-first-language-height-vh: 4.4cqw; /* vh height of .header-first-language */
				--header-second-language-height-vh: 4.4cqw; /* vh height of .header-second-language */
				--top-vh: calc(
					var(--headline-height-vh) + var(--header-first-language-height-vh) +
						var(--header-second-language-height-vh)
				);
				--top: calc(var(--top-vh) / 16 * 9);
			}

			/* a[data-content-type=departure]:not(:nth-child(1 of [data-content-type=departure])),
			a[data-content-type=arrival]:not(:nth-child(1 of [data-content-type=arrival])) */
			a:not(:first-child):not([data-prepended]) {
				margin-top: calc(-1 * var(--top));
				margin-bottom: calc(-1 * var(--bottom));
			}

			.fullscreen {
				border: none;
				font-size: 3cqw;
				padding: 2cqw;
				width: 100%;
				background-color: #0000ce;
				color: white;
			}
		</style>
	</head>
	<body>
		<section>
			<a><iframe></iframe></a>
			<a><iframe></iframe></a>
			<a><iframe></iframe></a>
			<a><iframe></iframe></a>
			<a><iframe></iframe></a>
			<a><iframe></iframe></a>
			<a><iframe></iframe></a>
			<button class="fullscreen">full screen</button>
		</section>

		<script>
			const fullscreenButtons = document.querySelectorAll(".fullscreen");
			const overscan = window.innerHeight / 3;
			const params = new URLSearchParams(
				"contentType=departure&staticLayout=true&ignoreIncident=true",
			);
			const urlParams = new URLSearchParams(location.search);
			urlParams.forEach((value, key) => params.set(key, value));
			const stationIds = urlParams.has("stationId")
				? urlParams.getAll("stationId").flatMap((value) => value.split(","))
				: ["8101003"];
			const contentTypes = urlParams.has("contentType")
				? urlParams.getAll("contentType").flatMap((value) => value.split(","))
				: ["departure"];
			const prependContentTypes = urlParams.has("prepend")
				? urlParams.getAll("prepend").flatMap((value) => value.split(","))
				: [];
			params.delete("prepend");

			const firstSection = document.querySelector("section");

			const sections = Array(Math.max(stationIds.length, contentTypes.length))
				.fill(firstSection)
				.map((s, i) => {
					if (i === 0) return s;
					const newSection = s.cloneNode(true);
					document.body.append(newSection);
					return newSection;
				});

			function reloadIframe(...iframes) {
				iframes.forEach((iframe) =>
					iframe.setAttribute("src", iframe.getAttribute("src")),
				);
			}

			function prepareIframe(iframe, contentType) {
				iframe.allowFullscreen = true;
				const src = `https://meine.oebb.at/webdisplay/?${params.toString()}`;
				iframe.dataset.src = src;
				const link = iframe.parentElement;
				link.href = src;
				link.dataset.contentType = contentType;
				link.addEventListener("click", (ev) => {
					ev.preventDefault();
					iframe.requestFullscreen();
					reloadIframe(iframe);
				});
			}

			function prependIframe(iframes, section, contentType) {
				const link = document.createElement("a");
				link.dataset.prepended = true;
				const iframe = document.createElement("iframe");
				link.append(iframe);
				params.delete("page");
				params.delete("offset");
				params.set("contentType", contentType);
				prepareIframe(iframe, contentType);
				link.style.zIndex = iframes.length + 1;
				section.prepend(link);
			}

			sections.forEach((section, boardIndex) => {
				const contentType = contentTypes[boardIndex] || contentTypes[0];
				params.set("stationId", stationIds[boardIndex] || stationIds[0]);
				params.set("contentType", contentType);
				const iframes = section.querySelectorAll("iframe");

				iframes.forEach((iframe, i) => {
					if (!["departure", "arrival"].includes(contentType) && i !== 0) {
						iframe.parentElement.style.display = "none";
						return;
					}
					params.set("page", i + 1);
					params.set("offset", i * 12);
					prepareIframe(iframe, contentType);
					iframe.parentElement.style.zIndex = iframes.length - i;
				});

				prependContentTypes
					.toReversed()
					.forEach((c) => prependIframe(iframes, section, c));
			});

			const allIframes = Array.from(document.querySelectorAll("iframe"));

			fullscreenButtons.forEach((btn) =>
				btn.addEventListener("click", () => {
					if (!document.fullscreenElement) {
						document.documentElement.requestFullscreen();
					} else {
						document.exitFullscreen();
					}
					reloadIframe(...allIframes);
				}),
			);

			function handleScroll() {
				allIframes.forEach((iframe) => {
					const { y, height } = iframe.getBoundingClientRect();
					const isVisible =
						y + height + overscan >= 0 && y - overscan <= window.innerHeight;
					const currentSrc = iframe.getAttribute("src");
					if (isVisible && !currentSrc)
						iframe.setAttribute("src", iframe.dataset.src);
					else if (!isVisible && currentSrc) iframe.setAttribute("src", "");
				});
			}
			function handleResize() {
				document.body.style.setProperty(
					"--scale",
					Math.min(
						1,
						(window.innerHeight / window.innerWidth) *
							((16 * sections.length) / 9 / 1.5),
					),
				);
			}
			handleResize();
			handleScroll();
			sections.forEach((s) => s.addEventListener("scroll", handleScroll));
			window.addEventListener("resize", handleResize);
		</script>
	</body>
</html>
